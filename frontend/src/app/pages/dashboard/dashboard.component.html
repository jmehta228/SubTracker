<!-- Dashboard Layout with Sidebar -->
<div class="dashboard-layout">
  <!-- Mobile Overlay -->
  @if (mobileMenuOpen) {
    <div class="mobile-overlay" (click)="mobileMenuOpen = false"></div>
  }

  <!-- Sidebar Navigation -->
  <app-sidebar
    [userEmail]="userEmail"
    [username]="username"
    [isCollapsed]="sidebarCollapsed"
    [class.mobile-open]="mobileMenuOpen"
    (collapsedChange)="sidebarCollapsed = $event"
    (onLogout)="onLogout()"
    (onLinkBank)="openPlaid()"
  ></app-sidebar>

  <!-- Main Content Area -->
  <main class="main-content" [class.sidebar-collapsed]="sidebarCollapsed">
    <!-- Background decoration -->
    <div class="bg-decoration"></div>

    <!-- Page Header -->
    <header class="page-header">
      <div class="header-content">
        <div class="header-left">
          <!-- Mobile Menu Toggle -->
          <button
            class="mobile-menu-btn"
            (click)="mobileMenuOpen = !mobileMenuOpen"
            [attr.aria-label]="mobileMenuOpen ? 'Close menu' : 'Open menu'"
            [attr.aria-expanded]="mobileMenuOpen"
          >
            @if (mobileMenuOpen) {
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
              </svg>
            }
          </button>
          <div class="header-text">
            <h1>Dashboard</h1>
            <p>Track and manage your subscriptions in one place</p>
          </div>
        </div>
        <button class="btn btn-primary btn-lg" (click)="toggleAddForm()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Subscription
        </button>
      </div>
    </header>

    <!-- Stats Overview -->
    <section class="stats-section" aria-label="Subscription statistics">
      <div class="stats-grid">
        <app-stats-card
          label="Total Monthly"
          [value]="'$' + (monthlyTotal | number:'1.2-2')"
          [subtext]="subscriptions.length + ' active subscriptions'"
          variant="primary"
        >
          <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
        </app-stats-card>

        <app-stats-card
          label="Yearly Estimate"
          [value]="'$' + (yearlyTotal | number:'1.2-2')"
          subtext="Projected annual cost"
          variant="accent"
        >
          <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </app-stats-card>

        <app-stats-card
          label="Due This Week"
          [value]="upcomingCount.toString()"
          [subtext]="upcomingCount === 1 ? 'renewal coming up' : 'renewals coming up'"
          variant="warning"
        >
          <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
        </app-stats-card>

        <app-stats-card
          label="Active Subs"
          [value]="subscriptions.length.toString()"
          subtext="Total tracked subscriptions"
          variant="secondary"
        >
          <svg icon xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </app-stats-card>
      </div>
    </section>

    <!-- Add Subscription Form (Collapsible) -->
    @if (showAddForm) {
      <section class="add-form-section animate-fade-in-down">
        <div class="glass-card form-card">
          <div class="form-header">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
              </svg>
              Add New Subscription
            </h2>
            <button class="btn-icon" (click)="showAddForm = false" aria-label="Close form">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <form (ngSubmit)="addSubscription()" #subForm="ngForm" class="subscription-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="name" class="form-label">Subscription Name</label>
                <input
                  id="name"
                  type="text"
                  placeholder="e.g., Netflix, Spotify"
                  [(ngModel)]="name"
                  name="name"
                  required
                  aria-label="Subscription name"
                />
              </div>

              <div class="form-group">
                <label for="amount" class="form-label">Amount</label>
                <div class="input-with-prefix">
                  <span class="input-prefix">$</span>
                  <input
                    id="amount"
                    type="number"
                    placeholder="0.00"
                    [(ngModel)]="amount"
                    name="amount"
                    step="0.01"
                    min="0"
                    required
                    aria-label="Subscription amount"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="frequency" class="form-label">Billing Frequency</label>
                <select
                  id="frequency"
                  [(ngModel)]="frequency"
                  name="frequency"
                  required
                  aria-label="Billing frequency"
                >
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>

              <div class="form-group">
                <label for="dueDate" class="form-label">Next Billing Date</label>
                <input
                  id="dueDate"
                  type="date"
                  [(ngModel)]="dueDate"
                  name="dueDate"
                  required
                  aria-label="Next billing date"
                />
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-ghost" (click)="showAddForm = false">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
                @if (isSubmitting) {
                  <span class="spinner"></span>
                  Adding...
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  Add Subscription
                }
              </button>
            </div>
          </form>
        </div>
      </section>
    }

    <!-- Subscriptions List -->
    <section class="subscriptions-section" aria-label="Your subscriptions">
      <div class="section-header">
        <h2>My Subscriptions</h2>
        @if (subscriptions.length > 0) {
          <span class="subscription-count">{{ subscriptions.length }} total</span>
        }
      </div>

      <!-- Loading State -->
      @if (isLoading) {
        <div class="subscriptions-grid">
          @for (i of [1, 2, 3]; track i) {
            <app-skeleton variant="card" height="280px"></app-skeleton>
          }
        </div>
      }

      <!-- Empty State -->
      @else if (subscriptions.length === 0) {
        <app-empty-state
          title="No subscriptions yet"
          description="Start tracking your subscriptions by adding your first one. We'll help you stay on top of renewals and spending."
          actionText="Add Your First Subscription"
          (action)="toggleAddForm()"
        >
          <svg icon xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
        </app-empty-state>
      }

      <!-- Subscription Cards Grid -->
      @else {
        <div class="subscriptions-grid">
          @for (sub of subscriptions; track sub._id; let i = $index) {
            <app-subscription-card
              [id]="sub._id"
              [name]="sub.name"
              [amount]="sub.amount"
              [frequency]="sub.frequency"
              [dueDate]="sub.dueDate"
              [recommendation]="sub.recommendation"
              (paid)="handlePaid($event)"
              (edit)="handleEdit($event)"
              (delete)="handleDelete($event)"
              [style.animation-delay]="(i * 50) + 'ms'"
            ></app-subscription-card>
          }
        </div>
      }
    </section>
  </main>
</div>

<!-- Edit Subscription Modal -->
@if (showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content glass-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
            <path d="m15 5 4 4"/>
          </svg>
          Edit Subscription
        </h2>
        <button class="btn-icon" (click)="closeEditModal()" aria-label="Close modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form (ngSubmit)="saveEdit()" class="subscription-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="editName" class="form-label">Subscription Name</label>
            <input
              id="editName"
              type="text"
              placeholder="e.g., Netflix, Spotify"
              [(ngModel)]="editName"
              name="editName"
              required
              aria-label="Subscription name"
            />
          </div>

          <div class="form-group">
            <label for="editAmount" class="form-label">Amount</label>
            <div class="input-with-prefix">
              <span class="input-prefix">$</span>
              <input
                id="editAmount"
                type="number"
                placeholder="0.00"
                [(ngModel)]="editAmount"
                name="editAmount"
                step="0.01"
                min="0"
                required
                aria-label="Subscription amount"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="editFrequency" class="form-label">Billing Frequency</label>
            <select
              id="editFrequency"
              [(ngModel)]="editFrequency"
              name="editFrequency"
              required
              aria-label="Billing frequency"
            >
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editDueDate" class="form-label">Next Billing Date</label>
            <input
              id="editDueDate"
              type="date"
              [(ngModel)]="editDueDate"
              name="editDueDate"
              required
              aria-label="Next billing date"
            />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-ghost" (click)="closeEditModal()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="isUpdating">
            @if (isUpdating) {
              <span class="spinner"></span>
              Saving...
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Save Changes
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Toast Notifications -->
<app-toast></app-toast>
